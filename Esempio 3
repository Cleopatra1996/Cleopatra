import pandas as pd
from fuzzywuzzy import process
import mysql.connector

# Connessione al database
cnx = mysql.connector.connect(user='superandreani', password='franzandreani',
                              host='10.20.0.51', database='cinetel4', raise_on_warnings=True)
cur = cnx.cursor()

# Caricamento del file Excel
df_excel = pd.read_excel('PERIODO CORRENTE MEDUSA.xls')

# Estrazione dei dati dalla colonna 'Comune' del dataframe Excel
comuni_excel = set(df_excel['Comune'].dropna().str.strip().tolist())
# Estrazione dei dati dalla colonna 'Denominazione' del dataframe Excel
denominazioni_excel = set(df_excel['Denominazione'].dropna().str.strip().tolist())
# Estrazione dei dati dalla colonna 'Titolo' del dataframe Excel
titolo_excel = set(df_excel['Titolo'].dropna().str.strip().tolist())
# Estrazione dei dati dalla colonna 'Data' del dataframe Excel
df_excel['Data'] = df_excel['Data'].astype(str).str.strip()
# Estrazione dei dati dalla colonna 'citta' della tabella 'sala' del database
cur.execute("SELECT citta FROM cinetel4.citta ORDER BY citta ASC;")
comuni_db = set([row[0].strip() for row in cur.fetchall()])



# Estrazione dei dati dalla colonna 'Denominazione' della tabella 'film' del database
cur.execute("SELECT SUBSTRING_INDEX(nome_cinema, '-', 1) AS nome_cinema FROM cinetel4.anag_cinema WHERE nome_cinema NOT LIKE '%-%' ORDER BY nome_cinema ASC;")
denominazioni_db = set([row[0].strip() for row in cur.fetchall()])

# Estrazione dei dati dalla colonna 'Titolo' della tabella 'anagrafica_film' del database
cur.execute("SELECT titolo FROM cinetel4.anagrafica_film ORDER BY titolo ASC;")
titolo_db = set([row[0].strip() for row in cur.fetchall()])

# Estrazione dei dati dalla colonna 'Data' della tabella 'film' del database
cur.execute("SELECT ultima_program FROM cinetel4.anagrafica_film ORDER BY ultima_program;")
data_db = set([str(row[0]).strip() for row in cur.fetchall()])


comuni_diff_excel = []
for comune_excel in comuni_excel:
    match = process.extractOne(comune_excel, comuni_db)
    if match[1] >= 80:  # Soglia di similitudine
        comuni_diff_excel.append((comune_excel, match[0], match[1]))
comuni_diff_excel = pd.DataFrame(comuni_diff_excel, columns=['Comune Excel', 'Comune DB', 'Somiglianza'])

comuni_diff_db = []
for comune_db in comuni_db:
    match = process.extractOne(comune_db, comuni_excel)
    if match is None or match[1] < 80:
        comuni_diff_db.append((comune_db,))
comuni_diff_db = pd.DataFrame(comuni_diff_db, columns=['Comune DB'])



# Confronto tra le denominazioni presenti nel file Excel e quelle presenti nel database
denominazioni_diff_excel = []
for denominazione_excel in denominazioni_excel:
    match = process.extractOne(denominazione_excel, denominazioni_db)
    if match[1] >= 80:  # Soglia di similitudine
        denominazioni_diff_excel.append((denominazione_excel, match[0], match[1]))
denominazioni_diff_excel = pd.DataFrame(denominazioni_diff_excel,
                                        columns=['Denominazione Excel', 'Denominazione DB', 'Somiglianza'])

denominazioni_diff_db = []
for denominazione_db in denominazioni_db:
    match = process.extractOne(denominazione_db, denominazioni_excel)
    if match[1] < 80:
        denominazioni_diff_db.append((denominazione_db,))
denominazioni_diff_db = pd.DataFrame(denominazioni_diff_db, columns=['Denominazione DB'])

# Confronto tra i titolo presenti nel file Excel e quelle presenti nel database
titolo_diff_excel = []
for titolo_excel in titolo_excel:
    match = process.extractOne(titolo_excel, titolo_db)
    if match[1] >= 80:  # Soglia di similitudine
        titolo_diff_excel.append((titolo_excel, match[0], match[1]))
titolo_diff_excel = pd.DataFrame(titolo_diff_excel, columns=['Titolo Excel', 'Titolo DB', 'Somiglianza'])

titolo_diff_db = []
for titolo_db in titolo_db:
    match = process.extractOne(titolo_db, titolo_excel)
    if match[1] < 80:
        titolo_diff_db.append((titolo_db,))
titolo_diff_db = pd.DataFrame(titolo_diff_db, columns=['Titolo DB'])

# Confronto tra data presenti nel file Excel e quelle presenti nel database
data_diff_excel = []
for data_excel in df_excel['Data'].tolist():
    match = process.extractOne(data_excel, data_db)
    if match[1] >= 80:  # Soglia di similitudine
        data_diff_excel.append((data_excel, match[0], match[1]))
data_diff_excel = pd.DataFrame(data_diff_excel, columns=['Data Excel', 'Data DB', 'Somiglianza'])

data_diff_db = []
for data_db_element in data_db:
    match = process.extractOne(str(data_db_element), df_excel['Data'].astype(str).tolist())
    if match is None or match[1] < 80:
        data_diff_db.append((str(data_db_element),))
data_diff_db = pd.DataFrame(data_diff_db, columns=['Data DB'])


with pd.ExcelWriter('differenze_excel_db.xlsx') as writer:
    comuni_diff_excel.to_excel(writer, sheet_name='Differenze', index=False)
    comuni_diff_db.to_excel(writer, sheet_name='Differenze', index=False, startcol=len(comuni_diff_excel.columns) + 2)

    denominazioni_diff_excel.to_excel(writer, sheet_name='Differenze', index=False,
                                      startcol=len(comuni_diff_excel.columns) + len(comuni_diff_db.columns) + 4)
    denominazioni_diff_db.to_excel(writer, sheet_name='Differenze', index=False,
                                      startcol=len(comuni_diff_excel.columns) + len(comuni_diff_db.columns) + len(denominazioni_diff_excel.columns) + 6)

    titolo_diff_excel.to_excel(writer, sheet_name='Differenze', index=False,
                                      startcol=len(comuni_diff_excel.columns) + len(comuni_diff_db.columns) + len(denominazioni_diff_excel.columns) + len(denominazioni_diff_db.columns) + 8)

    titolo_diff_db.to_excel(writer, sheet_name='Differenze', index=False,
                                      startcol=len(comuni_diff_excel.columns) + len(comuni_diff_db.columns) + len(denominazioni_diff_excel.columns) + len(denominazioni_diff_db.columns) + len(titolo_diff_excel.columns) + 10)

    data_diff_excel.to_excel(writer, sheet_name='Differenze', index=False,
                             startcol=len(comuni_diff_excel.columns) + len(comuni_diff_db.columns) + len(denominazioni_diff_excel.columns) + len(denominazioni_diff_db.columns) + len(titolo_diff_excel.columns) + len(titolo_diff_db.columns) + 14)
    data_diff_db.to_excel(writer, sheet_name='Differenze', index=False,
                          startcol=len(comuni_diff_excel.columns) + len(comuni_diff_db.columns) + len(denominazioni_diff_excel.columns) + len(denominazioni_diff_db.columns) + len(titolo_diff_excel.columns) + len(titolo_diff_db.columns) + len(data_diff_excel.columns) + 16)

# Chiusura delle connessioni
cur.close()
cnx.close()
